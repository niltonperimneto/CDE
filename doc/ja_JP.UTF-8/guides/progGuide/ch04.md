
# セッション・マネージャとの統合


セッション・マネージャは、ユーザが（現在のセッションから）ログアウトするときや、ユーザが（ホーム・セッションとして）環境を保存するときに、デスクトップ環境と実行中のアプリケーションに関する情報を保存します。
アプリケーションが現在のセッッションまたはホーム・セッションの一部として保存され、次のセッションの一部として再起動されるためには、Xクライアント間通信規約マニュアル（ICCCM）1.1のセッション管理プロトコルに関与する必要があります。
この章では、セッション・マネージャがセッションを保存し、復元する方法を概説し、アプリケーションがセッション管理に関与するために必要な手順を詳しく述べます。






# セッション・マネージャがセッション及びアプリケーションを保存する方法


セッションを終了するときや、ホーム・セッションを保存するとき、 セッション・マネージャは次のことを行います。

選択されたリソース設定とXサーバ設定を保存する。

各アプリケーションが状態を保存できるようにして、保存の完了を待つ。

アプリケーションの再起動に必要なコマンド行を獲得する。
# セッション管理のためのアプリケーションのプログラム方法

# プログラム環境の設定


この節では、統合プロセスの一部としてアプリケーションを保存するために必要なプログラミングの手順を説明します。

プログラム環境を設定するには、次の手順に従います。

次のヘッダ・ファイルを組み込みます。

Xm/Xm.h

Xm/Protocols.h

Dt/Session.h

libXmとlibDtSvcをリンクします。

ツールキットを初期化して、トップレベル・ウィジェットを作成します。
# WM_SAVE_YOURSELFアトムの設定


次の例で示すように、MotifのXmAddWMProtocol()関数を利用して、アプリケーションのトップレベル・ウィンドウのWM_PROTOCOLS属性のWM_SAVE_YOURSELFアトムを設定します。Atom XaWmSaveYourself;

Display *dsp;



dsp = XtDisplay(toplevel);

XaWmSaveYourself =

XmInternAtom(dsp, &rdquo;WM_SAVE_YOURSELF&rdquo;, False);

XmAddWMProtocols(toplevel, &amp;XaWmSaveYourself, 1);

複数のウィンドウに対してWM_SAVE_YOURSELFアトムを設定しないでください。
# WM_SAVE_YOURSELFメッセージを受け取るための準備


MotifのXmAddWMProtocolCallback()関数を使用して、アプリケーションがWM_SAVE_YOURSELFクライアント・メッセージを受け取ったときに呼び出されるコールバック・プロシージャを設定します。XmAddWMProtocolCallback(toplevel, XaWmSaveYourself,
SaveYourselfProc,
   toplevel);
# WM_SAVE_YOURSELFメッセージの処理


セッション・マネージャがこのアプリケーションのトップレベル・ウィンドウにWM_SAVE_YOURSELFクライアント・メッセージを送ると、SaveYourselfProc()コールバック・プロシージャが呼び出されます。
このコールバックを使用して、アプリケーションの状態を保存します。
アプリケーションはプログラマが選んだ任意の方法で状態を保存できますが、保存中はユーザと対話できません。

セッション・マネージャは、アプリケーションの状態を保存するための絶対パス名とベース・ファイル名を返す手段として、DtSessionSavePath()関数を提供します。
# WM_COMMAND属性の設定


アプリケーションがWM_SAVE_YOURSELFメッセージの処理
（状態を保存するか、メッセージを無視する）を終了した後、
アプリケーションはトップレベル・ウィンドウのWM_COMMAND属性を設定して、保存操作が完了したことをセッション・マネージャに知らせなければなりません。

アプリケーションのトップレベル・ウィンドウのWM_COMMAND属性を設定するには、XlibのXsetCommand()関数を使います。
この属性を設定することによって、アプリケーションがWM_SAVE_YOURSELFメッセージの処理を終了したことを
セッション・マネージャに知らせ、アプリケーションを再起動するために必要なコマンド行を
セッション・マネージャに与えます。

XsetCommand()は、コマンド引数の配列を受け入れます。
アプリケーションが保存プロセスの一部としてDtSessionSavePath()関数を使用する場合には、XsetCommand()には追加のコマンド引数&hyphen;session`basename`が必要です。`basename`は、DtSessionSavePath()によって返されるベース・ファイル名です。
# セッション・マネージャがセッションを復元する方法


セッション・マネージャは、次のようにしてセッションを復元します。

リソース・データベースとサーバ設定を復元する。

保存されたコマンド行を使用して、アプリケーションを再起動する。

アプリケーションが、保存された状態のパスを見つけるためにDtSessionSavePath()を使用した場合には、
アプリケーションはベース・ファイル名を-session引数からDtSessionRestorePath()関数に渡して、保存状態の絶対パス名を見つけることができます。