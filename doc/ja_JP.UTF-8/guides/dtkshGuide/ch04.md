複雑なスクリプト複雑なスクリプトこの章は、2章で説明したスクリプトよりも、さらに複雑なスクリプトについて説明します。
このスクリプトは非常に長いため、スクリプト全体は、付録Cにリストします。
このマニュアルは、KornShellプログラミングのチュートリアルではありません。
KornShellプログラミングをあまり理解していない場合は、KornShellプログラミング用の
マニュアルを入手し、参照してください。script_findの使用方法スクリプトscript_findscript_findは、dtkshを使用して、findコマンドのグラフィカル・インタフェースを
提供する方法を示しています。script_findは、findコマンドのパラメータを
指定できるウィンドウを生成します。スクリプトを完全に理解するには、findを理解し、
マニュアル・ページを使用可能にしておく必要があります。script_findによって
生成されるウィンドウ内の多くのトグル・ボタン・メニュー選択肢は、findコマンドの
知識が多少必要です。スクリプトのウィンドウで、検索するディレクトリとファイル名を指定します。
他のオプションで、検索用のファイル・システムの型と一致するファイルの型を
制限できます。図4-1にscript_findのウィンドウを示します。script_findのウィンドウウィンドウの上部にあるテキスト・フィールドに、捜したい検索ディレクトリとファイル名
を入力します。そして、5つのトグル・ボタンから適用可能な選択（または選択肢）を
選択します。オプション・メニューで、検索をさらに制限できます。必要な選択をすべて
行ってから[OK]ボタンをクリックします。処理が正常に終ると、その後すぐに
ウィンドウが現れ、find操作の結果が表示されます。検索ディレクトリ
またはファイル名を指定しないと、または無効なディレクトリを指定すると、エラー・
ダイアログが表示されます。たとえば、/users/dlmディレクトリ
下のどこにtwo_letter_callsというファイルがあるか捜しますとします。
検索ディレクトリのテキスト・フィールドに、そのディレクトリを入力するときに、/users/dlmの代わりに/users/dlnと誤って入力したと
します。その状態で、[OK]または[Apply]をクリックすると、script_findは、/users/dlnディレクトリを見つけることができません。
そのため、エラー・ダイアログを生成して、これをユーザに通知します。script_findエラー・ダイアログ誤りを訂正すると、script_findは適切に実行し、要求したファイルの
絶対パスを表示したdttermウィンドウを生成し、ファイルが見つかった
ことを示します。絶対パスが示されているウィンドウscript_findが指定したディレクトリに見つからなかった時は、dttermウィンドウには何も表示されません。script_findの解析script_findの構造は、Cプログラムと似ています。初めにいくつかの関数とコールバック、
次にメイン・スクリプトが示されるという構造です。スクリプトの初めの2行は重要で、すべてのdtkshスクリプトに含める
必要があります。#! /usr/dt/bin/dtksh
. /usr/dt/lib/dtksh/DtFunc.dtsh1行めはdtkshシステムを実行します。2行めはdtksh簡易関数をロードします。
2行めは、第2章で説明したスクリプトには使用されていません。それは、これらの
スクリプトがdtksh簡易関数を使用しないためです。関数とコールバックコールバックscript_findscript_findには、次の関数とコールバックがあります。PostErrorDialog()OkCallback()LoadStickyValues()EvalCmd()RetrieveAndSaveCurrentValues()PostErrorDialog()この関数は、ユーザが無効なディレクトリを入力したときなど、エラーの発見時に呼び
出されます。この関数は、ダイアログ・ボックスを表示
し、簡易関数DtkshDisplayErrorDialogDtkshDisplayErrorDialog()を呼び出されます。
この関数は、「Find Error」というタイトルで、呼び出した位置から渡される変数$1にメッセージが格納されているダイアログ・ボックスを表示します。dialogPostErrorDialog()
{
     DtDisplayErrorDialog &ldquo;Find Error&rdquo; &ldquo;$1&rdquo; \
     DIALOG_PRIMARY_APPLICATION_MODAL
}最後のパラメータ、DIALOG_PRIMARY_APPLICATION_MODALは、他の相互動作が発生する前に
応答しなければならないダイアログを生成するようにdtkshに伝えます。OkCallback()OkCallback()は、メインのscript_findウィンドウ上の[OK]または[Apply]ボタンの
どちらかを押されると呼び出されます。 [OK]をボタンを押すと、script_findウィンドウ
は管理されなくなります。[OK]または[Apply]ボタンで、入力した検索ディレクトリを
確認します。それが無効な場合、OkCallback()は、PostErrorDialog()を
呼び出します。それが有効な場合は、script_findのトグル・ボタンの状態がチェックされ、
その状態と一致するように、変数$CMDを調整します。
この変数には、最後に実行されるコマンドのすべてが含まれます。LoadStickyValues()この関数は、ウィンドウが生成および管理された後、メイン・プリグラムから呼び出され
ます。スクリプトの最新の実行結果から、すべての値をロードします。
それらの値はRetrieveandSaveCurrentValues()関数によって、Find.stickyファイルに保存されます。EvalCmd()EvalCmd()はLoadStickyValues()で使用され、dtkshコマンドとしてFind.stickyの各行を評価します。Find.stickyファイル内のリストが次のとおりです。XmTextSetString $SD &ldquo;/users/dlm&rdquo;XmTextSetStringXmTextFieldSetInsertionPosition $SD 10XmTextFieldSetInsertionPositionXmTextSetString $FNP &ldquo;two_letter_calls&rdquo;XmTextSetStringXmTextFieldSetInsertionPosition $FNP 16XmTextFieldSetInsertionPositionXtSetValues $FSTYPE menuHistory:$NODIRXtSetValuesXtSetValues $FILETYPE menuHistory:$NOTYPEXtSetValuesXmToggleButtonSetState $T2 true falseXmToggleButtonSetStateXmToggleButtonSetState $T4 true falseXmToggleButtonSetStateRetrievAndSaveCurrentValues()RetrieveAndSaveCurrentValues()は、script_findウィンドウにあるウィジェットの現在の設定と値を
検索し、それらをFind.stickyファイルに保存します。Find.stickyファイルは、次にスクリプトが実行される時に、LoadStickyValues()によって使用されます。メイン・スクリプトスクリプトの残りは、CプログラムのMain()に相当するものです。Xtイントリンシクス
を初期化し、script_findウィンドウで使用するすべてのウィジェットを生成します。
1行めのset -fは、dtkshに対し、パス名にあるワイルドカードの文字列の
拡張を禁止するよう指示しています。これは、findコマンドがこの拡張を実行できる
ようにするために必要です。script_findウィンドウ(図4-4参照)は、4つの領域をもつフォーム・ウィジェットから
構成されます。領域は、セパレータ・ウィジェットによって明確にされています。
それぞれの領域にはいくつかのウィジェットがあり、そのすべてがフォーム・ウィジェット
の子になります。script_findウィンドウにあるウィジェットウィジェットは、領域ごとに順番に、上から下へ作成されます。初期化初期化は、次のようなXtイントリンシクス関数XtInitializeで行います。XtInitialize TOPLEVEL find Dtksh $0 &ldquo;${@:-}&rdquo;XtInitializeこれは、次に生成されるフォーム・ウィジェットの親であるトップレベル・
シェルを生成します。フォーム・ウィジェットの生成ウィジェットフォームフォーム・ウィジェットの生成メインの親ウィジェットとしてフォーム・ウィジェットを使用します。
フォーム・ウィジェットは、ユーザが子ウィジェットを抑制できるマネージャ・
ウィジェットです。メインのscript_findウィンドウにあるほとんどのウィジェットが
フォーム・ウィジェットの子です。残りのウィジェットの作成の説明は、ウィンドウの
4つの領域(図4-4参照)ごとに説明します。1つめの領域1つめの領域は、2つのラベル・ウィジェットと2つのテキストフィールド・ウィジェット、
および1つめと2つめの領域を区切るセパレータから構成されています。script_findウィンドウの1つめの領域次のコードの部分は、1つめのラベル・ウィジェットを生成および配置し、DtkshAnchorTopおよびDtkshAnchorLeft簡易関数を使用して、フォーム・ウィジェットにそれを
配置します。XtCreateManagedWidget SDLABEL sdlabel XmLabel $FORM \XtCreateManagedWidgetlabelString:&rdquo;Search Directory:&rdquo; \
  $(DtkshAnchorTop 12) \
  $(DtkshAnchorLeft 10)次のコードの部分は、1つめのテキストフィールド・ウィジェットを生成および配置
しています。このウィジェットは、フォーム・ウィジェットとラベル・ウィジェットの
両方に関連して配置されます。XtCreateManagedWidget SD sd XmText $FORM \XtCreateManagedWidgetcolumns:30 \
  value:&rdquo;.&rdquo; \
  $(DtkshAnchorTop 6) \
  $(DtkshRightOf $SDLABEL 10) \
  $(DtkshAnchorRight 10) \
  navigationType:EXCLUSIVE_TAB_GROUP
XmTextFieldSetInsertionPosition $SD 1XmTextFieldSetInsertionPosition残りのラベル・ウィジェットとテキストフィールト・ウィジェットは、同じ方法で生成
されます。セパレータ・ウィジェットはフォーム・ウィジェットの子として生成され、2つめのテキストフィールドの下に配置されます。ウィジェットセパレータ・ウィジェットセパレータ・ウィジェットはの生成XtCreateManagedWidget SEP sep XmSeparator $FORM \XtCreateManagedWidgetseparatorType:SINGLE_DASHED_LINE \
  $(DtkshUnder $FNP 10) \
  $(DtkshSpanWidth)2つめの領域2つめの領域は、1つのローカラム・ウィジェット、5つのトグルボタン・ガジェット、
およびセパレータ・ウィジェットから構成されます。script_findウィンドウの2つめの領域ガジェットは、多くの属性を、その親に依存するウィジェットで、メモリ・リソースを節約できます。ローカラム・ウィジェットは、フォーム・ウィジェットの子として生成され、1つめの
領域に生成されたセパレータ・ウィジェットの直下に配置されます。XtCreateManagedWidget RC rc XmRowColumn $FORM \XtCreateManagedWidgetorientation:HORIZONTAL \
       numColumns:3 \
       packing:PACK_COLUMN \
  $(DtkshUnder $SEP 10) \
  $(DtkshSpanWidth 10 10) \
  navigationType:EXCLUSIVE_TAB_GROUP5つのトグルボタン・ガジェットは、DtkshAddButtons簡易関数を使用して、
ローカラム・ウィジェットの子として生成されます。DtkshAddButtons -w $RC XmToggleButtonGadget \DtkshAddButtonsT1 &ldquo;Cross Mount Points&rdquo;           &ldquo;&ldquo;\
  T2 &ldquo;Print Matching Filenames&rdquo;     &ldquo;&ldquo;\
  T3 &ldquo;Search Hidden Subdirectories&rdquo; &ldquo;&ldquo;\
  T4 &ldquo;Follow Symbolic Links&rdquo;        &ldquo;&ldquo;\
  T5 &ldquo;Descend Subdirectories First&rdquo; &ldquo;&ldquo;次にセパレータ・ウィジェットが生成され、2つめと3つめの領域を区切ります。
このセパレータ・ウィジェットIDは、SEP2と呼ばれています。XtCreateManagedWidget SEP2 sep XmSeparator $FORM \XtCreateManagedWidgetseparatorType:SINGLE_DASHED_LINE \
 $(DtkshUnder $RC 10) \
 $(DtkshSpanWidth)3つめの領域3つめの領域は、2つのオプション・メニューとセパレータ・ウィジェットから生成されます。script_findウィンドウの3つめの領域オプション・メニューは、プルダウン・メニューです。ユーザがオプション・メニュー・
ボタンをクリックすると、多数の選択肢をもつメニュー区画が現れます。ユーザは、適切
な選択肢にポインタをドラッグし、マウス・ボタンを離します。メニュー区画は消え、
オプション・メニュー・ボタンのラベルに新しい選択肢が表示されます。メニューの作成メニューの作成1つめのオプション・メニューのメニュー区画は、多数のプッシュ・ボタン・ガジェット
から構成され、findコマンドに強いることができる様々な制約を表示しています。XmCreatePulldownMenu PANE $FORM paneXmCreatePulldownMenuDtkshAddButtons -w $PANE XmPushButtonGadget \DtkshAddButtonsNODIR &ldquo;no restrictions&rdquo; &ldquo;&ldquo;\
  NFS   &ldquo;nfs&rdquo;             &ldquo;&ldquo;\
  CDFS  &ldquo;cdfs&rdquo;            &ldquo;&ldquo;\
  HFS   &ldquo;hfs&rdquo;             &ldquo;&ldquo;
Next, the Option Menu button itself is created and managed, with the
menu pane just created ($PANE) identified as asubMenuId:
XmCreateOptionMenu FSTYPE $FORM fstype \XmCreateOptionMenulabelString:&rdquo;Restrict Search To File System Type:&rdquo; \
       menuHistory:$NODIR \
       subMenuId:$PANE \
  $(DtkshUnder $SEP2 20) \
  $(DtkshSpanWidth 10 10) \
  navigationType:EXCLUSIVE_TAB_GROUP
XtManageChild $FSTYPEXtManageChild2つめのオプション・メニュー・ボタンも、同じ方法で生成されます。このボタンは、findコマンドに、さらに制約を与えます。3つめのセパレータは、他のセパレータと同じ方法で生成されます。4つめの領域4つめの領域は、フォーム・ウィジェットの子である4つのプッシュ・ボタンから構成され
ています。4つのプッシュ・ボタンは次のように使用されます。[OK]は、script_findウィンドウに入力されたパラメータでfindコマンドを
実行し、script_findウィンドウを閉じます。[Apply]は、script_findウィンドウに入力されたパラメータでfindコマンドを実行します。script_findウィンドウは閉じません。[Close]は、findコマンドを実行せずにscript_findを終了します。[Help]は、script_findの使用に関する情報を示すダイアログ・ボックスを生成します。プッシュ・ボタンは、それぞれ異なったラベルが付きますが、他のウィジェットとほとんど
同じ方法で生成および配置されます。
次のコードの部分は、[OK]ボタンを生成する方法を示しています。XtCreateManagedWidget OK ok XmPushButton $FORM \XtCreateManagedWidgetlabelString:&rdquo;Ok&rdquo; \
  $(DtkshUnder $SEP3 10) \
  $(DtkshFloatLeft 4) \
  $(DtkshFloatRight 24) \
  $(DtkshAnchorBottom 10)
XtAddCallback $OK activateCallback &ldquo;OkCallback&rdquo;XtAddCallbackオペレーティング・パラメータの設定XtSetValuesは、最初のオペレーティング・パラメータを設定するのに使用します。XtSetValues $FORM \XtSetValuesinitialFocus:$SD \
  defaultButton:$OK \
  cancelButton:$CLOSE \
  navigationType:EXCLUSIVE_TAB_GROUP最初のフォーカスは、1つめの領域の最初のテキストフィールド・ウィジェットに設定
されます。デフォルト・ボタンは4つめの領域の[OK]ボタンに設定されます。取消しボタンは4つめの領域の[Close]ボタンに設定されます。ナビゲーション型はEXCLUSIVE_TAB_GROUP.に設定されます。次の行は、改行キーがフォーム・ウィジェット内でデフォルト・ボタンをアクティブに
しないテキストフィールド・ウィジェットを構成します。使用方法の詳細は、付録BのEXCLUSIVE_TAB_GROUPの説明を参照してください。DtkshSetReturnKeyControls $SD $FNP $FORM $OK認識とループスクリプトの最後の3行は、script_findウィンドウの前の値をロードし、
トップレベル・ウィジェットを実現します。そして、ユーザの入力を待つループに入り
ます。LoadStickyValues
XtRealizeWidget $TOPLEVELXtRealizeWidgetXtMainLoopXtMainLoop